apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: gitlab-runner
  namespace: argocd
  labels:
    apps: utilities 
  annotations:
    notifications.argoproj.io/subscribe.on-sync-failed.mattermost: q51n59rsyjnyxexx5faeuuh8ua
    notifications.argoproj.io/subscribe.on-health-degraded.mattermost: q51n59rsyjnyxexx5faeuuh8ua
    notifications.argoproj.io/subscribe.on-sync-status-unknown.mattermost: q51n59rsyjnyxexx5faeuuh8ua
    
spec:
  project: default
  source:
    repoURL: https://charts.gitlab.io
    targetRevision: 0.84.0
    chart: gitlab-runner 

    helm:
      valuesObject: 
        certsSecretName: certs
        gitlabUrl: https://gitlab.lab.smig.tech
        secrets:
          - name: smigtech-cert
        rbac:
          create: true
          rules:
              - resources: ["events"]
                verbs: ["list", "watch"]
              - resources: ["pods"]
                verbs: ["create","delete","get", "list", "watch"]
              - apiGroups: [""]
                resources: ["pods/attach","pods/exec"]
                verbs: ["get","create","patch","delete"]
              - apiGroups: [""]
                resources: ["pods/log"]
                verbs: ["get","list"]
              - resources: ["secrets"]
                verbs: ["create","delete","get","update"]
              - resources: ["serviceaccounts"]
                verbs: ["get"]
              - resources: ["services"]
                verbs: ["create","get"]

        runners:
          secret: gitlab-runner
          name: k8s-runner
          cache:
            secretName: gitlab-runner
          config: |
                [[runners]]
                   executor = "kubernetes"
                   request_concurrency = 10
                  [runners.cache]
                    Type = "s3"
                    Path = "gl-runners"
                    Shared = false
                    [runners.cache.s3]
                      ServerAddress = "smig-zima.lab.smig.tech:9000"
                      BucketName = "gitlab-cache"
                      BucketLocation = "us-east-1"
                      Insecure = true
                      AuthenticationType = "access-key"
                  [runners.kubernetes]
                      namespace = "{{.Release.Namespace}}"
                      image = "arm64v8/alpine"
                      privileged = true
                      pull_policy = "if-not-present"
                      helper_image = "registry.gitlab.com/gitlab-org/gitlab-runner/gitlab-runner-helper:ubuntu-arm64-bleeding"
                  [runners.kubernetes.pod_resources]
                      cpu_limit = "4"
                      memory_limit = "6Gi"
                      cpu_request = "500m"
                      memory_request = "1Gi"
                  [[runners.kubernetes.volumes.secret]]
                      name = "smigtech-cert"
                      mount_path = "/secrets/smigtech/"
                  [[runners.kubernetes.volumes.empty_dir]]
                      name = "docker-certs"
                      mount_path = "/certs/client"
                      medium = "Memory"


  destination:
    server: https://kubernetes.default.svc
    namespace: gitlab-runner

  syncPolicy:
    syncOptions:
    - CreateNamespace=true
    automated:
      selfHeal: true
      prune: true
